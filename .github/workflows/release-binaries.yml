
name: 'Release'

on:
  workflow_dispatch:
    inputs:
      bump:
        type: choice
        description: Which semver number to bump
        options:
          - major
          - minor
          - patch
        default: minor
        required: true

jobs:
  next_version:
    name: Next version
    runs-on: ubuntu-latest
    outputs:
      previous_version: ${{ steps.prev_ver.outputs.previous_version }}
      next_version: ${{ steps.next_ver.outputs.next_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get current version
        id: prev_ver
        run: |
          set -x
          PREV_VER="$(cargo metadata --no-deps --all-features --format-version=1 | jq -r .packages[].version)"
          echo "current (soon to be previous) version: v$PREV_VER"
          echo ::set-output name=previous_version::"$PREV_VER"
      - name: Get next version
        id: next_ver
        run: |
          set -x
          echo "going to bump ${{ github.event.inputs.bump }} of v${{ steps.prev_ver.outputs.previous_version }}"
          NEXT_VER="$(curl -f https://next.tryin.top/${{ github.event.inputs.bump }}/${{ steps.prev_ver.outputs.previous_version }})"
          echo "next (soon to be current) version: v$NEXT_VER"
          echo ::set-output name=next_version::"$NEXT_VER"
      - name: Bump Cargo.toml
        run: |
          sed -Ei 's/^version\s+=\s+"[^"]*"/version = "${{ steps.next_ver.outputs.next_version }}"/' Cargo.toml
      - name: Check
        run: |
          cargo check
      - name: Commit & tag
          run: |
            echo
      #- name: Commit
        #TODO @mark: should commit, tag & push on main (if version number is to be in main branch)

  create_release:
    name: Create Github release
    needs: next_version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: release
        uses: actions/create-release@v1
        id: create_release
        with:
          draft: false
          prerelease: false
          release_name: v${{ needs.next_version.outputs.next_version }}"
          tag_name: v${{ needs.next_version.outputs.next_version }}"
          #body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ github.token }}
      - name: Upload readme to release
        uses: svenstaro/upload-release-action@v1-release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: README.md
          asset_name: README.md

  binary_matrix:
    name: Make matrix
    needs: next_version
    runs-on: ubuntu-latest
    outputs:
      bin_targets: ${{ steps.generate_matrix.outputs.bin_targets }}
      do_artifact: ${{ steps.conf.outputs.do_artifact }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Check conditions
        id: conf
        run: |
          echo ::set-output name=do_artifact::1;
          if [ "$(jq .release.artifact -r ci-conf.json)" = false ] || [ "$(jq .release.artifact -r ci-conf.json)" = null ]; then echo 'skipping because no release artifact config'; echo ::set-output name=artifact::0; fi
          if [ "$(jq .release.artifact.targets -r ci-conf.json)" = false ]; then echo 'skipping because no targets'; echo ::set-output name=artifact::0; fi
          if [ "$(jq .release.artifact.bins -r ci-conf.json)" = false ]; then echo 'skipping because no binaries'; echo ::set-output name=artifact::0; fi
      - name: Generate matrix
        id: generate_matrix
        if: steps.conf.outputs.do_artifact == 1
        run: |
          mat="$(jq .release.artifact -r ci-conf.json | jq '.targets[] + (.bins[] | {"bin": .})' | jq -sc '{"include":.}')"
          echo $mat
          echo ::set-output name=bin_targets::"$mat"

  binary:
    name: Release binaries
    needs: [binary_matrix, create_release]
    runs-on: ubuntu-latest
    if: needs.binary_matrix.outputs.do_artifact == 1
    strategy:
      matrix: ${{ fromJson(needs.binary_matrix.outputs.bin_targets) }}
    steps:
      - name: Log matrix
        run: |
          echo bin=${{ matrix.bin }}
          echo target=${{ matrix.target }}
          echo asset_postfix=${{ matrix.asset_postfix }}
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build project
        run: |
          cat ./ci/release.Dockerfile
          set -x
          docker build --build-arg BIN="${{ matrix.bin }}" --build-arg TARGET="${{ matrix.target }}" -t release-image -f ./ci/release.Dockerfile .
          id=$(docker create release-image)
          docker cp "$id:/${{ matrix.bin }}" "${{ matrix.bin }}"
      - name: Upload binary to release
        uses: svenstaro/upload-release-action@v1-release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: target/release/${{ matrix.bin }}
          asset_name: ${{ matrix.bin }}-${{ matrix.asset_postfix }}
